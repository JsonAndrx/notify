AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Notification Service (WA, SMS, Email)
Parameters:
  Env:
    Type: String
    Default: local
  DynamoEndpoint:
    Type: String
    Default: http://host.docker.internal:8000
  DynamoDBTable:
    Type: String
    Default: NotificationService
Globals:
  Function:
    Timeout: 10
    Runtime: provided.al2023
    MemorySize: 256
    Tracing: Active
    Environment:
      Variables:
        ENV:
          Ref: Env
        DYNAMO_ENDPOINT:
          Ref: DynamoEndpoint
        TABLE_NAME:
          Ref: DynamoDBTable
Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
  RegisterBusinessFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RegisterBusinessFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        RegisterBusinessApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/business/register
            Method: POST
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: RegisterBusinessFunction
      SamResourceId: RegisterBusinessFunction
  RegenerateAPIKeyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RegenerateAPIKeyFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        RegenerateKeyApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/account/regenerate-key
            Method: POST
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: RegenerateAPIKeyFunction
      SamResourceId: RegenerateAPIKeyFunction
  AccountInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AccountInfoFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        AccountInfoApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/account/info
            Method: GET
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: AccountInfoFunction
      SamResourceId: AccountInfoFunction
  PlanUsageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PlanUsageFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        PlanUsageApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/plan/usage
            Method: GET
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: PlanUsageFunction
      SamResourceId: PlanUsageFunction
  SendWhatsAppFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SendWhatsAppFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        SendWhatsAppApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/notifications/whatsapp
            Method: POST
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: SendWhatsAppFunction
      SamResourceId: SendWhatsAppFunction
  SendSMSFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SendSMSFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        SendSMSApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/notifications/sms
            Method: POST
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: SendSMSFunction
      SamResourceId: SendSMSFunction
  SendEmailFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SendEmailFunction
      Handler: bootstrap
      Runtime: provided.al2023
      Events:
        SendEmailApi:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGateway
            Path: /v1/notifications/email
            Method: POST
    Metadata:
      BuildMethod: makefile
      BuildProperties:
        Target: SendEmailFunction
      SamResourceId: SendEmailFunction
